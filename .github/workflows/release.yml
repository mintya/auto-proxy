name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # ä¸è¦å› ä¸ºä¸€ä¸ªæž„å»ºå¤±è´¥å°±åœæ­¢æ‰€æœ‰æž„å»º
      matrix:
        include:
          # macOS builds
          - target: x86_64-apple-darwin
            os: macos-latest
            platform: macos
            arch: x86_64
            use_cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            platform: macos
            arch: aarch64
            use_cross: false
          # Linux builds
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            platform: linux
            arch: x86_64
            use_cross: false  # åŽŸç”Ÿæž„å»ºæ›´å¿«
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            platform: linux
            arch: aarch64
            use_cross: true
          # Windows builds
          - target: x86_64-pc-windows-msvc  # ä½¿ç”¨ MSVC è€Œä¸æ˜¯ GNU
            os: windows-latest
            platform: windows
            arch: x86_64
            use_cross: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
        components: clippy, rustfmt

    # ä½¿ç”¨æ›´é«˜æ•ˆçš„ç¼“å­˜ç­–ç•¥
    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ matrix.target }}
        cache-on-failure: true

    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install openssl@3 pkg-config
        echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig" >> $GITHUB_ENV

    - name: Setup Windows environment
      if: runner.os == 'Windows'
      run: |
        echo "OPENSSL_NO_VENDOR=1" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Install cross
      if: matrix.use_cross == true
      run: |
        cargo install cross --git https://github.com/cross-rs/cross
        # æˆ–è€…ä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼ˆæ›´å¿«ï¼‰
        # curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
        # cargo binstall --no-confirm cross

    - name: Build binary
      run: |
        echo "ðŸ”¨ Building for ${{ matrix.platform }}-${{ matrix.arch }}..."
        
        if [ "${{ matrix.use_cross }}" = "true" ]; then
          cross build --release --target ${{ matrix.target }} --locked
        else
          cargo build --release --target ${{ matrix.target }} --locked
        fi
        
        echo "âœ… Build completed successfully"
      shell: bash

    - name: Run tests (native builds only)
      if: matrix.use_cross == false
      run: cargo test --release --target ${{ matrix.target }}

    - name: Strip binary (Unix only)
      if: runner.os != 'Windows'
      run: |
        BINARY_PATH="target/${{ matrix.target }}/release/auto-proxy"
        if [ -f "$BINARY_PATH" ]; then
          strip "$BINARY_PATH"
          echo "âœ… Binary stripped"
        fi

    - name: Prepare release assets
      id: prepare
      run: |
        # èŽ·å–ç‰ˆæœ¬å·
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release

        # ç¡®å®šäºŒè¿›åˆ¶æ–‡ä»¶å
        BINARY_NAME="auto-proxy"
        if [[ "${{ matrix.target }}" == *"windows"* ]]; then
          BINARY_NAME="auto-proxy.exe"
        fi

        # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
        BINARY_PATH="target/${{ matrix.target }}/release/$BINARY_NAME"
        if [ ! -f "$BINARY_PATH" ]; then
          echo "âŒ Binary not found: $BINARY_PATH"
          exit 1
        fi
        
        cp "$BINARY_PATH" release/
        
        # æ·»åŠ é¢å¤–æ–‡ä»¶
        if [ -f "README.md" ]; then
          cp README.md release/
        fi
        if [ -f "LICENSE" ]; then
          cp LICENSE release/
        fi

        # åˆ›å»ºåŽ‹ç¼©åŒ…
        cd release
        ARCHIVE_NAME="auto-proxy-$VERSION-${{ matrix.platform }}-${{ matrix.arch }}"
        
        if [[ "${{ matrix.target }}" == *"windows"* ]]; then
          # Windows ä½¿ç”¨ zip
          ARCHIVE_FILE="$ARCHIVE_NAME.zip"
          7z a "$ARCHIVE_FILE" *
        else
          # Unix ä½¿ç”¨ tar.gz
          ARCHIVE_FILE="$ARCHIVE_NAME.tar.gz"
          tar -czf "$ARCHIVE_FILE" *
        fi
        
        echo "ARCHIVE_NAME=$ARCHIVE_FILE" >> $GITHUB_ENV
        echo "ARCHIVE_PATH=release/$ARCHIVE_FILE" >> $GITHUB_ENV
        echo "archive_name=$ARCHIVE_FILE" >> $GITHUB_OUTPUT

        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        ls -la
        echo "ðŸ“¦ Created archive: $ARCHIVE_FILE"
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        if command -v du >/dev/null 2>&1; then
          echo "ðŸ“Š Archive size: $(du -h "$ARCHIVE_FILE" | cut -f1)"
        fi
      shell: bash

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.prepare.outputs.archive_name }}
        path: ${{ env.ARCHIVE_PATH }}
        retention-days: 7  # å‡å°‘å­˜å‚¨æ—¶é—´
        compression-level: 0  # æ–‡ä»¶å·²ç»åŽ‹ç¼©è¿‡äº†

  # æ·»åŠ å®‰å…¨æ£€æŸ¥ä½œä¸š
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
    
    - name: Run cargo audit
      run: |
        cargo install cargo-audit
        cargo audit

  release:
    name: Create Release
    needs: [build, security-audit]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write  # æ˜Žç¡®æƒé™

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽç”Ÿæˆå˜æ›´æ—¥å¿—

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        merge-multiple: true

    - name: Prepare release assets
      id: prepare
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV

        mkdir -p release-assets
        
        # ç§»åŠ¨æ‰€æœ‰åŽ‹ç¼©åŒ…åˆ°å‘å¸ƒç›®å½•
        find artifacts -name "*.tar.gz" -o -name "*.zip" | while read file; do
          cp "$file" release-assets/
        done

        echo "ðŸ“¦ Release assets:"
        ls -la release-assets/

        # ç”Ÿæˆæ ¡éªŒå’Œ
        cd release-assets
        if command -v sha256sum >/dev/null 2>&1; then
          sha256sum * > SHA256SUMS
        elif command -v shasum >/dev/null 2>&1; then
          shasum -a 256 * > SHA256SUMS
        fi
        
        echo "âœ… Generated checksums:"
        cat SHA256SUMS

    - name: Generate changelog
      id: changelog
      run: |
        # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREV_TAG" ]; then
          echo "## ðŸ”„ Changes since $PREV_TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
        else
          echo "## ðŸŽ‰ Initial Release" > CHANGELOG.md
        fi
        
        echo "" >> CHANGELOG.md

    - name: Generate release notes
      run: |
        cat > release-notes.md << EOF
        # Auto Proxy v${{ env.VERSION }}

        ## ðŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ

        è¿™æ˜¯ Auto Proxy çš„ v${{ env.VERSION }} ç‰ˆæœ¬ï¼Œä¸€ä¸ªæ”¯æŒå¤šæä¾›å•†çš„æ™ºèƒ½ä»£ç†æœåŠ¡å™¨ã€‚

        $(cat CHANGELOG.md)

        ## âœ¨ ä¸»è¦ç‰¹æ€§

        - ðŸ”„ å¤šæä¾›å•†æ”¯æŒï¼Œè‡ªåŠ¨é‡è¯•å’Œæ•…éšœè½¬ç§»
        - ðŸŽ¯ æ™ºèƒ½è´Ÿè½½å‡è¡¡
        - ðŸ”’ Token éšç§ä¿æŠ¤
        - ðŸ“Š è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
        - ðŸŽ¨ ç¾Žè§‚çš„å½©è‰²ç•Œé¢

        ## ðŸ“¦ ä¸‹è½½

        è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š

        ### macOS
        - **Intel (x86_64)**: \`auto-proxy-${{ env.VERSION }}-macos-x86_64.tar.gz\`
        - **Apple Silicon (aarch64)**: \`auto-proxy-${{ env.VERSION }}-macos-aarch64.tar.gz\`

        ### Linux
        - **x86_64**: \`auto-proxy-${{ env.VERSION }}-linux-x86_64.tar.gz\`
        - **aarch64**: \`auto-proxy-${{ env.VERSION }}-linux-aarch64.tar.gz\`

        ### Windows
        - **x86_64**: \`auto-proxy-${{ env.VERSION }}-windows-x86_64.zip\`

        ## ðŸ”§ å¿«é€Ÿå®‰è£…

        ### Linux/macOS
        \`\`\`bash
        # ä¸‹è½½å¹¶è§£åŽ‹
        curl -L -o auto-proxy.tar.gz "https://github.com/\${{ github.repository }}/releases/download/v${{ env.VERSION }}/auto-proxy-${{ env.VERSION }}-\$(uname -s | tr '[:upper:]' '[:lower:]')-\$(uname -m).tar.gz"
        tar -xzf auto-proxy.tar.gz
        chmod +x auto-proxy
        ./auto-proxy --help
        \`\`\`

        ### Windows
        ä¸‹è½½ zip æ–‡ä»¶å¹¶è§£åŽ‹ï¼Œç„¶åŽè¿è¡Œ \`auto-proxy.exe --help\`

        ## ðŸ“‹ æ ¡éªŒå’Œ

        è¯·ä½¿ç”¨ \`SHA256SUMS\` æ–‡ä»¶éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š

        \`\`\`bash
        sha256sum -c SHA256SUMS
        \`\`\`

        ## ðŸ› é—®é¢˜åé¦ˆ

        å¦‚æžœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚

        ---
        
        **å®Œæ•´å˜æ›´æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...v${{ env.VERSION }}
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Auto Proxy v${{ env.VERSION }}
        body_path: release-notes.md
        files: |
          release-assets/*
        draft: false
        prerelease: ${{ contains(env.VERSION, 'alpha') || contains(env.VERSION, 'beta') || contains(env.VERSION, 'rc') }}
        generate_release_notes: false  # æˆ‘ä»¬è‡ªå·±ç”Ÿæˆäº†
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload to release summary
      run: |
        echo "ðŸŽ‰ Release v${{ env.VERSION }} created successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Assets uploaded:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -la release-assets/ >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }})" >> $GITHUB_STEP_SUMMARY
