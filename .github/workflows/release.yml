name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1
  PKG_CONFIG_ALLOW_CROSS: 1
  OPENSSL_STATIC: true

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - target: x86_64-apple-darwin
            os: macos-latest
            platform: macos
            arch: x86_64
            use_cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            platform: macos
            arch: aarch64
            use_cross: false
          # Linux builds
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            platform: linux
            arch: x86_64
            use_cross: false
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            platform: linux
            arch: aarch64
            use_cross: true
          # Windows builds
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            platform: windows
            arch: x86_64
            use_cross: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ matrix.target }}
        cache-on-failure: true

    - name: Install cross
      if: matrix.use_cross == true
      run: |
        cargo install cross --git https://github.com/cross-rs/cross
        
    - name: Set up cross-compilation environment
      if: matrix.use_cross == true
      run: |
        # è®¾ç½®çŽ¯å¢ƒå˜é‡ä»¥é¿å…OpenSSLä¾èµ–é—®é¢˜
        echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
        echo "OPENSSL_STATIC=true" >> $GITHUB_ENV

    - name: Update Cargo.toml version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "ðŸ·ï¸  Updating Cargo.toml version to $VERSION"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            sed -i '' "s/^version = .*/version = \"$VERSION\"/" Cargo.toml
          else
            sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml
          fi
          echo "âœ… Version updated in Cargo.toml"
        else
          echo "â„¹ï¸  Not a tag build, keeping original version"
        fi
      shell: bash

    - name: Build binary
      run: |
        echo "ðŸ”¨ Building for ${{ matrix.platform }}-${{ matrix.arch }}..."
    
        if [ "${{ matrix.use_cross }}" = "true" ]; then
          cross build --release --target ${{ matrix.target }}
        else
          cargo build --release --target ${{ matrix.target }}
        fi
    
        echo "âœ… Build completed successfully"
      shell: bash


    - name: Run tests (native builds only)
      if: matrix.use_cross == false
      run: cargo test --release --target ${{ matrix.target }}

    - name: Strip binary (Unix only)
      if: runner.os != 'Windows'
      run: |
        BINARY_PATH="target/${{ matrix.target }}/release/auto-proxy"
        if [ -f "$BINARY_PATH" ]; then
          strip "$BINARY_PATH" || true
          echo "âœ… Binary stripped"
        fi

    - name: Prepare release assets
      id: prepare
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        mkdir -p release

        BINARY_NAME="auto-proxy"
        if [[ "${{ matrix.target }}" == *"windows"* ]]; then
          BINARY_NAME="auto-proxy.exe"
        fi

        BINARY_PATH="target/${{ matrix.target }}/release/$BINARY_NAME"
        if [ ! -f "$BINARY_PATH" ]; then
          echo "âŒ Binary not found: $BINARY_PATH"
          exit 1
        fi
        
        cp "$BINARY_PATH" release/
        
        if [ -f "README.md" ]; then
          cp README.md release/
        fi
        if [ -f "LICENSE" ]; then
          cp LICENSE release/
        fi

        cd release
        ARCHIVE_NAME="auto-proxy-$VERSION-${{ matrix.platform }}-${{ matrix.arch }}"
        
        if [[ "${{ matrix.target }}" == *"windows"* ]]; then
          ARCHIVE_FILE="$ARCHIVE_NAME.zip"
          7z a "$ARCHIVE_FILE" *
        else
          ARCHIVE_FILE="$ARCHIVE_NAME.tar.gz"
          tar -czf "$ARCHIVE_FILE" *
        fi
        
        echo "ARCHIVE_NAME=$ARCHIVE_FILE" >> $GITHUB_ENV
        echo "ARCHIVE_PATH=release/$ARCHIVE_FILE" >> $GITHUB_ENV
        echo "archive_name=$ARCHIVE_FILE" >> $GITHUB_OUTPUT

        ls -la
        echo "ðŸ“¦ Created archive: $ARCHIVE_FILE"
        
        if command -v du >/dev/null 2>&1; then
          echo "ðŸ“Š Archive size: $(du -h "$ARCHIVE_FILE" | cut -f1)"
        fi
      shell: bash

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.prepare.outputs.archive_name }}
        path: ${{ env.ARCHIVE_PATH }}
        retention-days: 7
        compression-level: 0

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
    
    - name: Run cargo audit
      run: |
        cargo install cargo-audit
        cargo audit

  release:
    name: Create Release
    needs: [build, security-audit]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        merge-multiple: true

    - name: Prepare release assets
      id: prepare
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV

        mkdir -p release-assets
        
        find artifacts -name "*.tar.gz" -o -name "*.zip" | while read file; do
          cp "$file" release-assets/
        done

        echo "ðŸ“¦ Release assets:"
        ls -la release-assets/

        cd release-assets
        if command -v sha256sum >/dev/null 2>&1; then
          sha256sum * > SHA256SUMS
        elif command -v shasum >/dev/null 2>&1; then
          shasum -a 256 * > SHA256SUMS
        fi
        
        echo "âœ… Generated checksums:"
        cat SHA256SUMS

    - name: Generate changelog
      id: changelog
      run: |
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREV_TAG" ]; then
          echo "## ðŸ”„ Changes since $PREV_TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
        else
          echo "## ðŸŽ‰ Initial Release" > CHANGELOG.md
        fi
        
        echo "" >> CHANGELOG.md

    - name: Generate release notes
      run: |
        cat > release-notes.md << EOF
        # Auto Proxy v${{ env.VERSION }}

        ## ðŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ

        è¿™æ˜¯ Auto Proxy çš„ v${{ env.VERSION }} ç‰ˆæœ¬ï¼Œä¸€ä¸ªæ”¯æŒå¤šæä¾›å•†çš„æ™ºèƒ½ä»£ç†æœåŠ¡å™¨ã€‚

        $(cat CHANGELOG.md)

        ## âœ¨ ä¸»è¦ç‰¹æ€§

        - ðŸ”„ **å¤šæä¾›å•†æ”¯æŒ**: é…ç½®å¤šä¸ªAPIæä¾›å•†ï¼Œè‡ªåŠ¨è´Ÿè½½å‡è¡¡
        - âš–ï¸ **æ™ºèƒ½è´Ÿè½½å‡è¡¡**: è½®è¯¢ç®—æ³•ç»“åˆå¥åº·åº¦æƒé‡ï¼Œè‡ªåŠ¨åˆ†æ•£è´Ÿè½½
        - ðŸ¥ **å¥åº·åº¦ç›‘æŽ§**: å®žæ—¶è¿½è¸ªä¾›åº”å•†å¥åº·çŠ¶æ€ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨é™æƒ
        - ðŸš€ **å¿«é€Ÿæ•…éšœè½¬ç§»**: ä¸å¥åº·ä¾›åº”å•†è‡ªåŠ¨è·³è¿‡ï¼Œç¡®ä¿æœåŠ¡è¿žç»­æ€§
        - ðŸš¨ **ç´§æ€¥æ¢å¤æ¨¡å¼**: æ‰€æœ‰ä¾›åº”å•†ä¸‹çº¿æ—¶è‡ªåŠ¨å¯åŠ¨æ¢å¤æœºåˆ¶
        - ðŸŽ¯ **æ™ºèƒ½é‡è¯•**: æ ¹æ®å¥åº·åº¦è°ƒæ•´é‡è¯•ç­–ç•¥ï¼Œå‡å°‘æ— æ•ˆè¯·æ±‚
        - ðŸš¦ **é€ŸçŽ‡é™åˆ¶**: å¯é…ç½®çš„æ¯åˆ†é’Ÿè¯·æ±‚é™åˆ¶ï¼Œé˜²æ­¢APIè¿‡è½½
        - ðŸŽ® **äº¤äº’å¼ç•Œé¢**: ç¾Žè§‚çš„å®žæ—¶ç»ˆç«¯UIç•Œé¢ï¼Œæ˜¾ç¤ºæœåŠ¡å•†çŠ¶æ€å’Œæ—¥å¿—
        - ðŸ–±ï¸ **é¼ æ ‡æŽ§åˆ¶**: æ”¯æŒé¼ æ ‡ç‚¹å‡»æ“ä½œï¼Œå¯éšæ—¶å¯ç”¨/ç¦ç”¨æœåŠ¡å•†
        - ðŸ“Š **å®žæ—¶ç›‘æŽ§**: æ˜¾ç¤ºå¥åº·åº¦ã€é€ŸçŽ‡é™åˆ¶ã€Tokenä½¿ç”¨æƒ…å†µç­‰å®žæ—¶æ•°æ®
        - ðŸŒ **ç½‘ç»œçŠ¶æ€**: å®žæ—¶ç½‘ç»œè¿žé€šæ€§æ£€æµ‹å’ŒçŠ¶æ€æ˜¾ç¤º
        - ðŸ”’ **éšç§ä¿æŠ¤**: æ—¥å¿—ä¸­è‡ªåŠ¨å±è”½æ•æ„Ÿçš„Tokenä¿¡æ¯
        - ðŸ“ˆ **Tokenç»Ÿè®¡**: å®žæ—¶ç»Ÿè®¡å„æœåŠ¡å•†çš„Tokenä½¿ç”¨é‡å’Œå æ¯”
        - âš¡ **é«˜æ€§èƒ½**: åŸºäºŽRustå’ŒTokioçš„å¼‚æ­¥æž¶æž„ï¼Œä½¿ç”¨rustlsæä¾›TLSæ”¯æŒ
        - ðŸŽ¨ **ç¾Žè§‚ç•Œé¢**: å½©è‰²ç»ˆç«¯è¾“å‡ºï¼Œæå‡ç”¨æˆ·ä½“éªŒ
        - ðŸ”§ **æ˜“äºŽé…ç½®**: ç®€å•çš„JSONé…ç½®æ–‡ä»¶
        - ðŸŒ **è·¨å¹³å°**: æ”¯æŒ macOSã€Linux å’Œ Windows

        ## ðŸŽ® äº¤äº’å¼ç•Œé¢

        æœ¬ç‰ˆæœ¬åŒ…å«å…¨æ–°çš„äº¤äº’å¼ç»ˆç«¯ç•Œé¢ï¼š
        - ðŸ“Š å®žæ—¶çŠ¶æ€é¢æ¿æ˜¾ç¤ºæ‰€æœ‰æœåŠ¡å•†çŠ¶æ€
        - ðŸ–±ï¸ é¼ æ ‡ç‚¹å‡»æ“ä½œï¼Œå¯éšæ—¶å¯ç”¨/ç¦ç”¨æœåŠ¡å•†
        - âŒ¨ï¸ é”®ç›˜å¿«æ·é”®æ”¯æŒ (Q/Escé€€å‡ºï¼ŒCtrl+Cå¼ºåˆ¶é€€å‡º)
        - ðŸ“‹ å½©è‰²å®žæ—¶æ—¥å¿—æ˜¾ç¤º
        - ðŸŒ ç½‘ç»œçŠ¶æ€ç›‘æŽ§
        - ðŸ“ˆ Tokenä½¿ç”¨ç»Ÿè®¡

        ## ðŸ“¦ ä¸‹è½½

        è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š

        ### macOS
        - **Intel (x86_64)**: \`auto-proxy-${{ env.VERSION }}-macos-x86_64.tar.gz\`
        - **Apple Silicon (aarch64)**: \`auto-proxy-${{ env.VERSION }}-macos-aarch64.tar.gz\`

        ### Linux
        - **x86_64**: \`auto-proxy-${{ env.VERSION }}-linux-x86_64.tar.gz\`
        - **aarch64**: \`auto-proxy-${{ env.VERSION }}-linux-aarch64.tar.gz\`

        ### Windows
        - **x86_64**: \`auto-proxy-${{ env.VERSION }}-windows-x86_64.zip\`

        ## ðŸ”§ å¿«é€Ÿå®‰è£…

        ### Linux/macOS
        \`\`\`bash
        curl -L -o auto-proxy.tar.gz "https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/auto-proxy-${{ env.VERSION }}-\$(uname -s | tr '[:upper:]' '[:lower:]')-\$(uname -m).tar.gz"
        tar -xzf auto-proxy.tar.gz
        chmod +x auto-proxy
        ./auto-proxy --help
        \`\`\`

        ### Windows
        ä¸‹è½½ zip æ–‡ä»¶å¹¶è§£åŽ‹ï¼Œç„¶åŽè¿è¡Œ \`auto-proxy.exe --help\`

        ## ðŸš€ å¿«é€Ÿå¼€å§‹

        1. **å¯åŠ¨ç¨‹åº**: \`./auto-proxy\` (ä½¿ç”¨äº¤äº’å¼ç•Œé¢)
        2. **é…ç½®æ–‡ä»¶**: é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ¨¡æ¿
        3. **ç¼–è¾‘é…ç½®**: åœ¨ \`~/.claude-proxy-manager/providers.json\` ä¸­æ·»åŠ æ‚¨çš„APIæä¾›å•†
        4. **é‡æ–°å¯åŠ¨**: ä¿å­˜é…ç½®åŽé‡å¯ç¨‹åºå³å¯ä½¿ç”¨

        ## ðŸ“‹ æ ¡éªŒå’Œ

        è¯·ä½¿ç”¨ \`SHA256SUMS\` æ–‡ä»¶éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š

        \`\`\`bash
        sha256sum -c SHA256SUMS
        \`\`\`

        ## ðŸ› é—®é¢˜åé¦ˆ

        å¦‚æžœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚

        ---
        
        æ„Ÿè°¢ä½¿ç”¨ Auto Proxyï¼å¦‚æžœæ­¤é¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·è€ƒè™‘ç»™ä¸ª â­ï¸ï¼
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Auto Proxy v${{ env.VERSION }}
        body_path: release-notes.md
        files: |
          release-assets/*
        draft: false
        prerelease: ${{ contains(env.VERSION, 'alpha') || contains(env.VERSION, 'beta') || contains(env.VERSION, 'rc') }}
        generate_release_notes: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload to release summary
      run: |
        echo "ðŸŽ‰ Release v${{ env.VERSION }} created successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Assets uploaded:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -la release-assets/ >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }})" >> $GITHUB_STEP_SUMMARY
